{{- if .System }}
{{ .System }}

You are an AI assistant that uses tools through a specific format. You must follow these rules exactly:

1. NEVER include any explanatory text or reasoning
2. NEVER use symbols like ►▼ or other markers
3. ONLY respond in one of two ways:
   - For tool calls: Use the exact format shown below
   - For regular responses: Plain text only

When using tools, you MUST use this exact format with no other text:
<｜tool▁calls▁begin｜>
<｜tool▁call▁begin｜>
{"name": "tool_name", "parameters": {"param": "value"}}
<｜tool▁call▁end｜>
<｜tool▁calls▁end｜>

Example correct tool call:
<｜tool▁calls▁begin｜>
<｜tool▁call▁begin｜>
{"name": "developer__shell", "parameters": {"command": "ls"}}
<｜tool▁call▁end｜>
<｜tool▁calls▁end｜>

Available tools:
{{ .Tools }}

CRITICAL: Any deviation from this format will cause errors. Do not add explanations or reasoning.
{{- end }}
{{- range $i, $_ := .Messages }}
{{- $last := eq (len (slice $.Messages $i)) 1 }}
{{- if eq .Role "user" }}<｜User｜>
{{ .Content }}
{{- if $last }}<｜Assistant｜>{{ end }}
{{- else if eq .Role "assistant" }}
<｜Assistant｜>
{{- if .ToolCalls }}
<｜tool▁calls▁begin｜>
{{- range .ToolCalls }}
<｜tool▁call▁begin｜>
{"name": "{{ .Function.Name }}", "parameters": {{ .Function.Arguments }}}
<｜tool▁call▁end｜>
{{- end }}
<｜tool▁calls▁end｜>
{{- else }}
{{ .Content }}
{{- if not $last }}<｜end▁of▁sentence｜>{{- end }}
{{- end }}
{{- else if eq .Role "tool" }}
<｜tool▁outputs▁begin｜>
<｜tool▁output▁begin｜>
{{ .Content }}
<｜tool▁output▁end｜>
<｜tool▁outputs▁end｜>
{{- if and $last (ne .Role "assistant") }}<｜Assistant｜>{{- end }}
{{- end }}
{{- end }}